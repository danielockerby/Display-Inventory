SELECT
    main.dt,
    main.group_type,
    main.at_mid,
    SUM(agg.total_impressions) AS impressions,
    SUM(agg.total_clicks) AS clicks
FROM (
    SELECT DISTINCT
        dt,
        group_type,
        REGEXP_SUBSTR(item_link, '^.*[?&]at_mid=([a-zA-Z0-9]*)[^&at_]?', 1, 1, 'e') AS at_mid
    FROM "redshiftdb"."s3_audience"."audience_activity"
    WHERE
        destination = 'PS_NEWS'
        AND dt BETWEEN '20240501' AND '20240531'
        AND item_link LIKE '%display_ad%'
        AND event_action = 'view'
        AND group_type != 'footer promos'
        AND group_type != 'rich text'
        AND content_type = 'index-home'
) AS main
JOIN (
    SELECT
        dt,
        REGEXP_SUBSTR(item_link, '^.*[?&]at_mid=([a-zA-Z0-9]*)[^&at_]?', 1, 1, 'e') AS at_mid,
        group_type,
        COUNT(CASE WHEN event_action = 'view' THEN audience_id END) AS total_impressions,
        COUNT(CASE WHEN event_action = 'select' THEN audience_id END) AS total_clicks
    FROM "redshiftdb"."s3_audience"."audience_activity"
    WHERE
        destination = 'PS_NEWS'
        AND dt BETWEEN '20240501' AND '20240531'
        AND item_link LIKE '%display_ad%'
        AND (event_action = 'view' OR event_action = 'select')
        AND group_type != 'footer promos'
        AND group_type != 'rich text'
        AND content_type = 'index-home'
    GROUP BY dt, at_mid, group_type
) AS agg
ON main.dt = agg.dt AND main.at_mid = agg.at_mid AND main.group_type = agg.group_type
GROUP BY main.dt, main.group_type, main.at_mid
ORDER BY main.at_mid, main.group_type;
